<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reading Tracker</title>
<style>
  :root {
    --bg:#ffffff; --text:#000; --muted:#555;
    --primary:#4CAF50; /* green for this app */
    --active:#fff3cd; --outline:#f0c36d; --card:#fafafa;
  }
  html, body {
    margin:0; height:100%; background:var(--bg); color:var(--text);
    font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  .screen { display:none; min-height:100%; display:flex; align-items:center; justify-content:center; }
  .wrap {
    width:min(720px,92vw); background:var(--card); border:1px solid #eee;
    border-radius:16px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.08);
  }
  h1 { margin:0 0 12px; font-size:1.4rem; }
  p { margin:.2rem 0 .8rem; color:var(--muted); }
  textarea {
    width:100%; min-height:160px; padding:12px 14px; font-size:16px;
    border:1px solid #ccc; border-radius:10px; background:#fff; color:#000;
  }
  input[type=text]{
    width:100%; padding:12px 14px; font-size:16px; border:1px solid #ccc; border-radius:10px; background:#fff; color:#000;
  }
  button {
    border:none; border-radius:12px; padding:14px 16px; font-size:16px; cursor:pointer; font-weight:600;
  }
  .btn-start { background:#007bff; color:#fff; width:300px; font-size:1.6rem; padding:18px 0; }
  .btn-level { background:var(--primary); color:#fff; }
  .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .mt { margin-top:12px; }

  /* Reader screen specifics */
  #reader { position:fixed; inset:0; display:none; background:var(--bg); }
  #sentencesWrap { position:absolute; inset:2vh 3vw 12vh 3vw; overflow:hidden; }
  #sentences { width:100%; height:100%; }
  .sentence { margin:.35em 0; padding:.05em .1em; border-radius:8px; text-align:left; }
  .active { background:var(--active); outline:2px solid var(--outline); }
  #hud { position:fixed; right:3vw; bottom:2vh; display:flex; align-items:center; gap:12px; }
  #progress { background:rgba(0,0,0,.06); border-radius:999px; padding:.5rem 1rem; color:var(--muted); font-size:1rem; }
  #bigBtn { background:var(--primary); color:#fff; min-width:220px; }
</style>
</head>
<body>

<!-- START SCREEN -->
<div id="startScreen" class="screen" style="display:flex">
  <div class="wrap">
    <h1>Reading Tracker</h1>
    <p>Paste a reading passage below. This will highlight sentences log time per sentence.</p>
    <div class="row">
      <textarea id="passageInput" placeholder="Paste your text here..."></textarea>
    </div>

    <!-- Last line: Student # + Level buttons -->
    <div class="row mt">
      <input id="studentId" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Student # (optional)" style="flex:1;" />
      <button class="btn-level" data-level="A1" type="button">A1</button>
      <button class="btn-level" data-level="A2" type="button">A2</button>
      <button class="btn-level" data-level="B1" type="button">B1</button>
      <button class="btn-level" data-level="B2" type="button">B2</button>
      <button class="btn-level" data-level="C1" type="button">C1</button>
      <button class="btn-level" data-level="C2" type="button">C2</button>
    </div>

    <div class="row" style="margin-top:1rem; justify-content:center;">
      <button id="btnStart" class="btn-start" disabled>Start</button>
    </div>
  </div>
</div>

<!-- READER SCREEN -->
<div id="reader" aria-live="polite">
  <div id="sentencesWrap">
    <div id="sentences"></div>
  </div>
  <div id="hud">
    <div id="progress">—</div>
    <button id="bigBtn">Next →</button>
  </div>
</div>

<script>
// ====== Sentence splitting with robust rules ======
const ABBREV = ["Mr.","Mrs.","Ms.","Dr.","Prof.","Sr.","Jr.","vs.","e.g.","i.e.","etc."];
const OPENERS = ['"', "'", "“", "”", "‘", "’", "(", "[", "{"];

function isOpener(ch){ return OPENERS.includes(ch); }

function splitIntoSentences(text){
  text = (text||'').replace(/\r\n/g,'\n').replace(/\n+/g,' ').replace(/[ \t\f\v]+/g,' ').trim();
  const out = [];
  let i = 0, start = 0;
  while (i < text.length) {
    const ch = text[i];
    if (ch==='.' || ch==='?' || ch==='!') {
      let j = i-1;
      while (j>=0 && text[j]===' ') j--;
      let k = j;
      while (k>=0 && /[A-Za-z.]/.test(text[k])) k--;
      const prevToken = text.slice(k+1, j+1);
      let h = i+1;
      while (h<text.length && text[h]===' ') h++;
      while (h<text.length && isOpener(text[h])) h++;
      const nextIsCapital = h<text.length && /[A-Z]/.test(text[h]);
      const abbrevHit = ABBREV.includes(prevToken + ch);
      if (!abbrevHit && nextIsCapital) {
        const sent = text.slice(start, i+1).trim();
        if (sent) out.push(sent);
        i = h; start = i; continue;
      }
    }
    i++;
  }
  const tail = text.slice(start).trim();
  if (tail) out.push(tail);
  return out;
}

// ====== CSV helpers ======
function csvEscape(val){ if(typeof val==='string'){ return '"'+val.replace(/"/g,'""')+'"'; } return val; }
function downloadCSV(rows, filename, studentTag){
  const header=['student_number','sentence_index','sentence_text','word_count','dwell_seconds','wpm'];
  const lines=[header.join(',')];

  // write sentence rows
  rows.forEach(r=>{
    lines.push([csvEscape(studentTag), r.index, csvEscape(r.text), r.words, r.dwell.toFixed(2), r.wpm.toFixed(2)].join(','));
  });

  // ---- Calculate averages for "overall" row ----
  const totalWords = rows.reduce((sum, r) => sum + r.words, 0);
  const totalDwell = rows.reduce((sum, r) => sum + r.dwell, 0);
  const avgWords = rows.length ? totalWords / rows.length : 0;
  const avgDwell = rows.length ? totalDwell / rows.length : 0;
  // weighted average WPM = total words / (total dwell minutes)
  const weightedWpm = totalDwell > 0 ? (totalWords / (totalDwell/60)) : 0;

  // push overall row
  lines.push([
    csvEscape(studentTag), '', csvEscape('overall'),
    avgWords.toFixed(2),
    avgDwell.toFixed(2),
    weightedWpm.toFixed(2)
  ].join(','));

  const csv = "\uFEFF" + lines.join("\r\n");
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=filename || 'reading_sentences_manual.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
// ====== App state ======
let sentences=[], idx=0, tStart=null, results=[], studentTag='';

// Timestamp formatter YYYYMMDDHHMMSS
function formatStamp(ms){
  const d = new Date(ms);
  const pad = n => String(n).padStart(2,'0');
  const YYYY = d.getFullYear();
  const MM = pad(d.getMonth()+1);
  const DD = pad(d.getDate());
  const HH = pad(d.getHours());
  const mm = pad(d.getMinutes());
  const ss = pad(d.getSeconds());
  return `${YYYY}${MM}${DD}${HH}${mm}${ss}`;
}

// Render & layout
function renderSentences(){
  const box=document.getElementById('sentences');
  box.innerHTML='';
  sentences.forEach((s,i)=>{
    const div=document.createElement('div');
    div.className='sentence'; div.dataset.index=i; div.textContent=s;
    box.appendChild(div);
  });
  setActive(0);
  scaleToFit();
}

function setActive(i){
  document.querySelectorAll('.sentence').forEach(el=> el.classList.remove('active'));
  const el=document.querySelector('.sentence[data-index="'+i+'"]');
  if(el){ el.classList.add('active'); el.scrollIntoView({behavior:'smooth', block:'center'}); }
  idx=i;
  document.getElementById('progress').textContent = (i+1)+' / '+sentences.length;
  const btn=document.getElementById('bigBtn');
  btn.textContent = (i===sentences.length-1) ? 'Finish' : 'Next →';
}

// Font scaling to fill the window without scrolling
function scaleToFit(){
  const wrap=document.getElementById('sentencesWrap');
  const box=document.getElementById('sentences');
  let size=112; box.style.fontSize=size+'px';
  let guard=0;
  while(guard++<220){
    const fits = (box.scrollHeight <= wrap.clientHeight) && (box.scrollWidth <= wrap.clientWidth);
    if(fits){
      for(let step=8; step>=1; step=Math.floor(step/2)){
        box.style.fontSize=(size+step)+'px';
        if(box.scrollHeight <= wrap.clientHeight && box.scrollWidth <= wrap.clientWidth){
          size+=step;
        } else {
          box.style.fontSize=size+'px';
        }
      }
      break;
    }else{
      size-=2;
      if(size<=10){ size=10; box.style.fontSize=size+'px'; break; }
      box.style.fontSize=size+'px';
    }
  }
}

function wordsIn(s){ return (s.match(/\S+/g)||[]).length; }

// start button enable/disable
function refreshStartDisabled(){
  const hasText = (document.getElementById('passageInput').value.trim().length > 0);
  document.getElementById('btnStart').disabled = !hasText;
}

function startReading(){
  const text=document.getElementById('passageInput').value;
  sentences = splitIntoSentences(text);
  if(sentences.length===0){ alert('Please paste some text or choose a level.'); return; }

  // establish start time and student tag
  tStart = Date.now();
  const entered = (document.getElementById('studentId').value || '').trim();
  studentTag = entered || formatStamp(tStart);

  results=[];
  document.getElementById('startScreen').style.display='none';
  document.getElementById('reader').style.display='block';
  renderSentences();
}

function advance(){
  if(tStart==null) return;
  const delta=(Date.now()-tStart)/1000;
  const text=sentences[idx];
  const words=wordsIn(text);
  const wpm = delta>0 ? (words/(delta/60)) : 0;
  results.push({index: idx+1, text, words, dwell: delta, wpm});
  if(idx===sentences.length-1){
    finish();
  }else{
    setActive(idx+1);
    tStart=Date.now();
  }
}

function finish(){
  tStart=null;
  const fname = `reading_${studentTag}.csv`;
  downloadCSV(results, fname, studentTag);
}

// ====== Level button hookups ======
const LEVEL_PLACEHOLDERS = {
  A1: 'PLACEHOLDER-A1',
  A2: 'PLACEHOLDER-A2',
  B1: 'PLACEHOLDER-B1',
  B2: 'PLACEHOLDER-B2',
  C1: 'PLACEHOLDER-C1',
  C2: 'PLACEHOLDER-C2'
};

document.querySelectorAll('.btn-level').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const level = btn.getAttribute('data-level');
    const txt = LEVEL_PLACEHOLDERS[level] || '';
    const area = document.getElementById('passageInput');
    area.value = txt;
    area.focus();
    refreshStartDisabled();
  });
});

document.getElementById('passageInput').addEventListener('input', refreshStartDisabled);
document.getElementById('btnStart').addEventListener('click', startReading);
document.getElementById('bigBtn').addEventListener('click', advance);

window.addEventListener('keydown', (e)=>{
  if(document.getElementById('reader').style.display!=='block') return;
  if(e.key===' '||e.key==='Enter'||e.key==='ArrowRight'){ e.preventDefault(); advance(); }
});
window.addEventListener('resize', ()=>{ if(document.getElementById('reader').style.display==='block') scaleToFit(); });

// initialize start button state
refreshStartDisabled();
</script>
</body>
</html>
