<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reading Tracker</title>
<style>
  :root {
    --bg: #ffffff;
    --text: #000;
    --muted: #555;
    --primary: #4CAF50;
    --active: #fff3cd;
    --outline: #f0c36d;
    --card: #fafafa;
  }

  html, body {
    margin: 0;
    height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }

  .screen {
    display: none;
    min-height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .wrap {
    width: min(720px, 92vw);
    background: var(--card);
    border: 1px solid #eee;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 10px 30px rgba(0,0,0,.08);
  }

  h1 {
    margin: 0 0 12px;
    font-size: 1.4rem;
  }

  p {
    margin: .2rem 0 .8rem;
    color: var(--muted);
  }

  textarea {
    width: 100%;
    min-height: 160px;
    padding: 12px 14px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 10px;
    background: #fff;
    color: #000;
  }

  input[type=text] {
    width: 100%;
    padding: 12px 14px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 10px;
    background: #fff;
    color: #000;
  }

  button {
    border: none;
    border-radius: 12px;
    padding: 14px 16px;
    font-size: 16px;
    cursor: pointer;
    font-weight: 600;
  }

  .btn-start {
    background: #007bff;
    color: #fff;
    width: 300px;
    font-size: 1.6rem;
    padding: 18px 0;
  }

  .btn-level {
    background: var(--primary);
    color: #fff;
  }

  .row {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .mt {
    margin-top: 12px;
  }

  /* Reader screen specifics */
  #reader {
    position: fixed;
    inset: 0;
    display: none;
    background: var(--bg);
  }

  #sentencesWrap {
    position: absolute;
    inset: 2vh 3vw 12vh 3vw;
    display: flex;
    flex-direction: column;
  }

  #sentences {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: stretch;
  }

  .sentence {
    flex-grow: 1;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    font-size: clamp(1.2rem, 2.5vh, 3vh);
    padding-left: 1vw;
    padding-right: 1vw;
    border-radius: 10px;
    text-align: left;
    line-height: 1.3;
    color: rgba(0, 0, 0, 0.05); /* very faint text */
    transition: color 0.2s ease;
  }

  .active {
    background: var(--active);
    outline: 2px solid var(--outline);
    color: #000; /* readable text */
  }

  #hud {
    position: fixed;
    right: 3vw;
    bottom: 2vh;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  #progress {
    background: rgba(0,0,0,.06);
    border-radius: 999px;
    padding: .5rem 1rem;
    color: var(--muted);
    font-size: 1rem;
  }

  #bigBtn {
    background: var(--primary);
    color: #fff;
    min-width: 220px;
  }
</style>
</head>
<body>

<!-- START SCREEN -->
<div id="startScreen" class="screen" style="display:flex">
  <div class="wrap">
    <h1>Reading Tracker</h1>
    <p>Paste a reading passage below. This will highlight sentences and log time per sentence.</p>
    <div class="row">
      <textarea id="passageInput" placeholder="Paste your text here..."></textarea>
    </div>

    <!-- Last line: Student # + Level buttons -->
    <div class="row mt">
      <input id="studentId" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Student # (optional)" style="flex:1;" />
      <button class="btn-level" data-level="A1" type="button">A1</button>
      <button class="btn-level" data-level="A2" type="button">A2</button>
      <button class="btn-level" data-level="B1" type="button">B1</button>
      <button class="btn-level" data-level="B2" type="button">B2</button>
      <button class="btn-level" data-level="C1" type="button">C1</button>
      <button class="btn-level" data-level="C2" type="button">C2</button>
    </div>

    <div class="row" style="margin-top:1rem; justify-content:center;">
      <button id="btnStart" class="btn-start" disabled>Start</button>
    </div>
  </div>
</div>

<!-- READER SCREEN -->
<div id="reader">
  <div id="sentencesWrap">
    <div id="sentences"></div>
  </div>
  <div id="hud">
    <button id="btnUp">‚Üë Up</button>
    <button id="btnDown">‚Üì Down</button>
    <button id="bigBtn">Finish</button>
  </div>
</div>


<script>
// ====== Sentence splitting with robust rules ======
const ABBREV = ["Mr.","Mrs.","Ms.","Dr.","Prof.","Sr.","Jr.","vs.","e.g.","i.e.","etc."];
const OPENERS = ['"', "'", "‚Äú", "‚Äù", "‚Äò", "‚Äô", "(", "[", "{"];

function isOpener(ch){ return OPENERS.includes(ch); }

function splitIntoSentences(text){
  text = (text||'').replace(/\r\n/g,'\n').replace(/\n+/g,' ').replace(/[ \t\f\v]+/g,' ').trim();
  const out = [];
  let i = 0, start = 0;
  while (i < text.length) {
    const ch = text[i];
    if (ch==='.' || ch==='?' || ch==='!') {
      let j = i-1;
      while (j>=0 && text[j]===' ') j--;
      let k = j;
      while (k>=0 && /[A-Za-z.]/.test(text[k])) k--;
      const prevToken = text.slice(k+1, j+1);
      let h = i+1;
      while (h<text.length && text[h]===' ') h++;
      while (h<text.length && isOpener(text[h])) h++;
      const nextIsCapital = h<text.length && /[A-Z]/.test(text[h]);
      const abbrevHit = ABBREV.includes(prevToken + ch);
      if (!abbrevHit && nextIsCapital) {
        const sent = text.slice(start, i+1).trim();
        if (sent) out.push(sent);
        i = h; start = i; continue;
      }
    }
    i++;
  }
  const tail = text.slice(start).trim();
  if (tail) out.push(tail);
  return out;
}

// ====== CSV helpers ======
function csvEscape(val){ if(typeof val==='string'){ return '"'+val.replace(/"/g,'""')+'"'; } return val; }
function downloadCSV(rows, filename, studentTag){
  const header=['student_number','sentence_index','sentence_text','word_count','dwell_seconds','wpm'];
  const lines=[header.join(',')];

  // write sentence rows
  rows.forEach(r=>{
    lines.push([csvEscape(studentTag), r.index, csvEscape(r.text), r.words, r.dwell.toFixed(2), r.wpm.toFixed(2)].join(','));
  });

  // ---- Calculate averages for "overall" row ----
  const totalWords = rows.reduce((sum, r) => sum + r.words, 0);
  const totalDwell = rows.reduce((sum, r) => sum + r.dwell, 0);
  const avgWords = rows.length ? totalWords / rows.length : 0;
  const avgDwell = rows.length ? totalDwell / rows.length : 0;
  // weighted average WPM = total words / (total dwell minutes)
  const weightedWpm = totalDwell > 0 ? (totalWords / (totalDwell/60)) : 0;

  // push overall row
  lines.push([
    csvEscape(studentTag), '', csvEscape('overall'),
    avgWords.toFixed(2),
    avgDwell.toFixed(2),
    weightedWpm.toFixed(2)
  ].join(','));

  const csv = "\uFEFF" + lines.join("\r\n");
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=filename || 'reading_sentences_manual.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
// ====== App state ======
let sentences=[], idx=0, tStart=null, results=[], studentTag='';
let visibleStart = null;
let visibleAccum = 0;

// Timestamp formatter YYYYMMDDHHMMSS
function formatStamp(ms){
  const d = new Date(ms);
  const pad = n => String(n).padStart(2,'0');
  const YYYY = d.getFullYear();
  const MM = pad(d.getMonth()+1);
  const DD = pad(d.getDate());
  const HH = pad(d.getHours());
  const mm = pad(d.getMinutes());
  const ss = pad(d.getSeconds());
  return `${YYYY}${MM}${DD}${HH}${mm}${ss}`;
}

// Render & layout
function renderSentences(){
  const box=document.getElementById('sentences');
  box.innerHTML='';
  sentences.forEach((s,i)=>{
    const div=document.createElement('div');
    div.className='sentence'; div.dataset.index=i; div.textContent=s;
    box.appendChild(div);
  });
  setActive(0);
  scaleToFit();
}

function setActive(newIdx) {
  // Stop timing the previous sentence
  if (visibleStart != null && newIdx !== idx) {
    const delta = (Date.now() - visibleStart) / 1000;
    const dwell = visibleAccum + delta;

    const text = sentences[idx];
    const words = wordsIn(text);
    const wpm = dwell > 0 ? (words / (dwell / 60)) : 0;

    const existing = results.find(r => r.index === idx + 1);
    if (existing) {
      existing.dwell = dwell;
      existing.wpm = wpm;
    } else {
      results.push({ index: idx + 1, text, words, dwell, wpm });
    }
  }

  // Set new active sentence
  document.querySelectorAll('.sentence').forEach(el => el.classList.remove('active'));
  const el = document.querySelector(`.sentence[data-index="${newIdx}"]`);
  if (el) {
    el.classList.add('active');
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  idx = newIdx;
  visibleAccum = 0;
  visibleStart = document.visibilityState === 'visible' ? Date.now() : null;

  document.getElementById('progress').textContent = '';
}

// Font scaling to fill the window without scrolling
function scaleToFit() {
  const wrap = document.getElementById('sentencesWrap');
  const box = document.getElementById('sentences');

  // üß† Force reflow
  wrap.offsetHeight; box.offsetHeight;

  let size = 112;
  box.style.fontSize = size + 'px';

  let guard = 0;
  while (guard++ < 220) {
    const fits = (box.scrollHeight <= wrap.clientHeight) && (box.scrollWidth <= wrap.clientWidth);
    if (fits) {
      for (let step = 8; step >= 1; step = Math.floor(step / 2)) {
        box.style.fontSize = (size + step) + 'px';
        if (box.scrollHeight <= wrap.clientHeight && box.scrollWidth <= wrap.clientWidth) {
          size += step;
        } else {
          box.style.fontSize = size + 'px';
        }
      }
      break;
    } else {
      size -= 2;
      if (size <= 10) {
        size = 10;
        box.style.fontSize = size + 'px';
        break;
      }
      box.style.fontSize = size + 'px';
    }
  }
}

function wordsIn(s){ return (s.match(/\S+/g)||[]).length; }

// start button enable/disable
function refreshStartDisabled(){
  const hasText = (document.getElementById('passageInput').value.trim().length > 0);
  document.getElementById('btnStart').disabled = !hasText;
}

function startReading() {
  const text = document.getElementById('passageInput').value;
  sentences = splitIntoSentences(text);
  if (sentences.length === 0) {
    alert('Please paste some text or choose a level.');
    return;
  }

  // Establish start time and student tag
  tStart = Date.now();
  const entered = (document.getElementById('studentId').value || '').trim();
  studentTag = entered || formatStamp(tStart);

  results = [];

  // Switch to reader screen
  document.getElementById('startScreen').style.display = 'none';
  document.getElementById('reader').style.display = 'block';

  // Render sentences
  renderSentences();

  // ‚è±Ô∏è Use MutationObserver to wait until sentences are added
  const target = document.getElementById('sentences');
  const observer = new MutationObserver((mutationsList, observer) => {
    if (target.children.length > 0) {
      observer.disconnect();
      scaleToFit();
    }
  });
  observer.observe(target, { childList: true });
}

function advance() {
  if (visibleStart == null) return;

  const delta = (Date.now() - visibleStart) / 1000;
  const dwell = visibleAccum + delta;

  const text = sentences[idx];
  const words = wordsIn(text);
  const wpm = dwell > 0 ? (words / (dwell / 60)) : 0;

  const existing = results.find(r => r.index === idx + 1);
  if (existing) {
    existing.dwell = dwell;
    existing.wpm = wpm;
  } else {
    results.push({ index: idx + 1, text, words, dwell, wpm });
  }

  finish();
}

function moveUp() {
  if (idx > 0) {
    setActive(idx - 1);
    tStart = Date.now(); // reset timer
  }
}

function moveDown() {
  if (idx < sentences.length - 1) {
    setActive(idx + 1);
    tStart = Date.now(); // reset timer
  }
}

function finish(){
  tStart=null;
  const fname = `reading_${studentTag}.csv`;
  downloadCSV(results, fname, studentTag);
}

// ====== Level button hookups ======
const LEVEL_PLACEHOLDERS = {
  A1: 'Beautiful two-bedroom city flat five minutes\' walk from the cathedral. Fully equipped kitchen, living room with a large sofa and chairs, big TV and balcony. The balcony has space for four people to sit and gets the sun in the mornings, and the flat is light and warm. It has Wi-Fi and fast internet. The upstairs bedroom sleeps four people, with two double beds; the downstairs bedroom sleeps two in single beds. The flat is perfect for families and is near shops, bars and restaurants.',
  A2: 'What can I take on the plane as hand luggage? Please note that passengers can only take ONE suitcase onto the plane. It must be no bigger than 55cm x 22cm x 35cm and weigh no more than 10kg. You can also take one small laptop bag or handbag that can fit under the seat in front of you. If you have two bags, their total weight cannot be more than 10kg. If your bag is too big or too heavy, you will not be allowed to take it onto the plane. Staff will put it in the hold for you and you will have to pay extra. Please make sure mobile phones and other devices are fully charged so that security staff can check them. Liquids in bottles bigger than 100ml are allowed on board if you buy them in the airport shops after you\'ve passed security.  We hope you enjoy your flight!',
  B1: 'Whether you‚Äôre travelling to the islands or the mountains of Thailand, you‚Äôre likely to spend at least one night in its capital city on the way. Bangkok might be noisy and polluted but it‚Äôs also an exciting city with plenty of things to see and do. Why not make it a longer stay? Where to stay: The Khao San Road was a famous traveller spot even before Leonardo di Caprio‚Äôs character in the film The Beach stayed there. But it‚Äôs noisy, not very pretty and not very Thai. For something more authentic, Phra Kanong offers an alternative place to stay, with its fantastic street markets where everyday Bangkok people eat, work and live. It‚Äôs not as convenient for the main tourist sites, but it has a Skytrain station so you can be at the Grand Palace in 20 minutes. How to get around: Bangkok‚Äôs traffic can be a nightmare. Sure, you can easily take a taxi ‚Äì if you want to spend hours stuck in traffic jams ‚Äì but there are two much better ways to get around the city. To explore the temples and historical sites, catch an express boat river taxi or a longtail boat along the Chao Phraya river and the canals. For the modern part of the city, the Skytrain is a fast, cheap way to travel from the river to the shopping malls and nightlife of Sukhumvit, and the famous Chatuchak street market. Where to eat: The simple answer is: everywhere! Thai street food is among the best in the world, and for around $5 you can eat a filling and delicious meal. Some food stands have little plastic seats where you can sit and eat and they cook the same dish over and over, like fried chicken on rice or Pad Thai noodles. Head for Chinatown ‚Äì Yaowarat Street ‚Äì and choose whatever looks most interesting from the many excellent Chinese and Thai restaurants and food stands. What to do: After you‚Äôve seen the main sites like the Giant Buddha at the temple of Wat Pho and the spectacular Grand Palace, and shopped at Chatuchak market, check out the snake farm and watch the live snake show. You can even touch a snake yourself if you want to!',
  B2: 'In 2010, the planetary defence team at NASA had identified and logged 90 per cent of the asteroids near Earth measuring 1km wide. These ‚Äònear-Earth objects‚Äô, or NEOs, are the size of mountains and include anything within 50 million kilometres of Earth‚Äôs orbit. With an estimated 50 left to log, NASA says none of the 887 it knows about are a significant danger to the planet. Now NASA is working towards logging some of the smaller asteroids, those measuring 140 metres wide or more. Of the 25,000 estimated asteroids of this size, so far about 8,000 have been logged, leaving 17,000 unaccounted for. Considering that a 19-metre asteroid that exploded above the city of Chelyabinsk in Russia in 2013 injured 1,200 people, these middle-sized asteroids would be a serious danger if they enter Earth‚Äôs orbit. Whether NASA can find the remaining middle-sized NEOs depends on getting the money to build NEOCam, a 0.5-metre space telescope which would use infrared light to locate asteroids. If it did get the money, it could probably achieve its goal in ten years. Once logged, the planetary defence team would still need to work out how to defend the planet against being hit by the truly worrying asteroids ‚Äì the PHAs. ‚ÄòPotentially Hazardous Asteroids‚Äô are rocks close enough to pass within 7.5 million kilometres of Earth‚Äôs orbit. NASA has created a map of 1,400 PHAs, none of which are expected to be a threat in the next one hundred years. With technology already available, NASA can track these objects and make predictions about possible impact, at which point two defence solutions could be launched. The first is DART ‚Äì the Double Asteroid Redirection Test. Plans are scheduled to test DART on the moon of an asteroid called Didymos. ‚ÄòDidymoon‚Äô is 150 metres wide, orbiting its 800-metre mother, and hopefully the impact of DART will knock it out of its orbit enough for Earth-based telescopes to pick up. Another suggested defence against a PHA on course to hit Earth is to blow it up using a nuclear weapon. It may sound like a plot from a film, and it was the subject of the 1998 film Armageddon, but the Hypervelocity Asteroid Mitigation Mission for Emergency Response (HAMMER) is a genuine NASA proposal. The eight-ton rockets would be fired at an approaching asteroid with the hope of bumping it off course. If the asteroid was too close to Earth for this plan to work, the rockets would carry nuclear bombs to blow it up instead.',
  C1: 'When you picture mountain climbers scaling Mount Everest, what probably comes to mind are teams of climbers with Sherpa guides leading them to the summit, equipped with oxygen masks, supplies and tents. And in most cases you‚Äôd be right, as 97 per cent of climbers use oxygen to ascend to Everest‚Äôs summit at 8,850 metres above sea level. The thin air at high altitudes makes most people breathless at 3,500 metres, and the vast majority of climbers use oxygen past 7,000 metres. A typical climbing group will have 8‚Äì15 people in it, with an almost equal number of guides, and they‚Äôll spend weeks to get to the top after reaching Base Camp. But ultra-distance and mountain runner Kilian Jornet Burgada ascended the mountain in May 2017 alone, without an oxygen mask or fixed ropes for climbing. Oh, and he did it in 26 hours. With food poisoning. And then, five days later, he did it again, this time in only 17 hours. Born in 1987, Kilian has been training for Everest his whole life. And that really does mean his whole life, as he grew up 2,000 metres above sea level in the Pyrenees in the ski resort of Lles de Cerdanya in Catalonia, north-eastern Spain. While other children his age were learning to walk, Kilian was on skis. At one and a half years old he did a five-hour hike with his mother, entirely under his own steam. He left his peers even further behind when he climbed his first mountain and competed in his first cross-country ski race at age three. By age seven, he had scaled a 4,000er and, at ten, he did a 42-day crossing of the Pyrenees. He was 13 when he says he started to take it ‚Äòseriously‚Äô and trained with the Ski Mountaineering Technical Centre (CTEMC) in Catalonia, entering competitions and working with a coach. At 18, he took over his own ski-mountaineering and trail-running training, with a schedule that only allows a couple of weeks of rest a year. He does as many as 1,140 hours of endurance training a year, plus strength training and technical workouts as well as specific training in the week before a race. For his record-breaking ascent and descent of the Matterhorn, he prepared by climbing the mountain ten times until he knew every detail of it, even including where the sun would be shining at every part of the day. Sleeping only seven hours a night, Kilian Jornet seems almost superhuman. His resting heartbeat is extremely low at 33 beats per minute, compared with the average man‚Äôs 60 per minute or an athlete‚Äôs 40 per minute. He breathes more efficiently than average people too, taking in more oxygen per breath, and he has a much faster recovery time after exercise as his body quickly breaks down lactic acid ‚Äì the acid in muscles that causes pain after exercise. All this is thanks to his childhood in the mountains and to genetics, but it is his mental strength that sets him apart. He often sets himself challenges to see how long he can endure difficult conditions in order to truly understand what his body and mind can cope with. For example, he almost gave himself kidney failure after only drinking 3.5 litres of water on a 100km run in temperatures of around 40¬∞C. It would take a book to list all the races and awards he‚Äôs won and the mountains he‚Äôs climbed. And even here, Kilian‚Äôs achievements exceed the average person as, somehow, he finds time to record his career on his blog and has written three books, Run or Die, The Invisible Border and Summits of My Life.',
  C2: 'Functional Load (FL), which reflects the communicative importance of phonemic contrasts, is widely acknowledged in L2 pronunciation research but remains underutilized in automated pronunciation assessment (APA) systems. This study investigates how FL (high vs. low) and phoneme position (word-initial, medial, final) affect pronunciation difficulty among young Korean EFL learners. From an original dataset of 6000 read-aloud clips produced by 176 learners, 2739 clips were retained after filtering for signal quality and transcription accuracy. Phoneme-level scores were generated using Microsoft Azure‚Äôs Pronunciation Assessment tool, and a Many-Facet Rasch Measurement (MFRM) model was used to estimate phoneme difficulty across FL and positional variables. Findings revealed a small but statistically significant advantage for high-FL phonemes overall. However, phoneme position had a stronger impact: word-final phonemes consistently posed the greatest challenge, while medial phonemes were the easiest, regardless of FL. The interaction between FL and position was not significant, suggesting that positional effects operate independently. These results highlight the importance of incorporating both FL and phoneme position into pronunciation instruction and assessment. While FL helps identify phonemes critical to overall pronunciation effectiveness, addressing position-specific challenges‚Äîparticularly in word-final contexts constrained by L1 Korean phonotactics‚Äîmay yield greater improvements in learners‚Äô speech accuracy and comprehensibility.'
};

document.querySelectorAll('.btn-level').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const level = btn.getAttribute('data-level');
    const txt = LEVEL_PLACEHOLDERS[level] || '';
    const area = document.getElementById('passageInput');
    area.value = txt;
    area.focus();
    refreshStartDisabled();
  });
});

document.getElementById('passageInput').addEventListener('input', refreshStartDisabled);
document.getElementById('btnStart').addEventListener('click', startReading);
document.getElementById('bigBtn').addEventListener('click', advance);
document.getElementById('btnUp').addEventListener('click', moveUp);
document.getElementById('btnDown').addEventListener('click', moveDown);
document.addEventListener('visibilitychange', () => {
  if (document.getElementById('reader').style.display !== 'block') return;

  if (document.visibilityState === 'visible') {
    visibleStart = Date.now();
  } else if (visibleStart != null) {
    const delta = (Date.now() - visibleStart) / 1000;
    visibleAccum += delta;
    visibleStart = null;
  }
});

window.addEventListener('keydown', (e)=>{
  if(document.getElementById('reader').style.display!=='block') return;
  if(e.key===' '||e.key==='Enter'||e.key==='ArrowRight'){ e.preventDefault(); advance(); }
  if(e.key==='ArrowUp'){ e.preventDefault(); moveUp(); }
  if(e.key==='ArrowDown'){ e.preventDefault(); moveDown(); }
});
window.addEventListener('resize', ()=>{ if(document.getElementById('reader').style.display==='block') scaleToFit(); });

// initialize start button state
refreshStartDisabled();
</script>
</body>
</html>
