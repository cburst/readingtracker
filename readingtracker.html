<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reading Tracker</title>
<style>
  :root{
    --bg:#f8f8f5; --text:#000; --muted:#555; --accent:#4CAF50; --active:#fff3cd; --outline:#f0c36d;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Georgia,"Times New Roman",serif}
  #setup{max-width:900px;margin:40px auto;padding:16px}
  textarea{width:100%;min-height:160px;padding:12px;border-radius:12px;border:1px solid #ccc;background:#fff;color:#000;font-size:16px}
  button{padding:1rem 2rem;font-size:1.2rem;cursor:pointer;border:none;border-radius:16px}
  #btnStart{background:var(--accent);color:#fff;margin-top:12px}

  /* Fullscreen reader */
  #reader{position:fixed;inset:0;display:none;background:var(--bg)}
  #sentencesWrap{position:absolute;inset:2vh 3vw 12vh 3vw; overflow:hidden;}
  #sentences{width:100%;height:100%;}
  .sentence{margin:.35em 0; padding:.05em .1em; border-radius:8px; text-align:left}
  .active{background:var(--active); outline:2px solid var(--outline)}

  /* HUD */
  #hud{position:fixed;right:3vw;bottom:2vh;display:flex;align-items:center;gap:12px}
  #progress{background:rgba(0,0,0,.06);border-radius:999px;padding:.5rem 1rem;color:var(--muted);font-size:1rem}
  #bigBtn{background:var(--accent);color:#fff;min-width:220px}
</style>
</head>
<body>
  <div id="setup">
    <h1>Reading Tracker</h1>
    <p style="color:var(--muted)">Paste your text here. Sentences are split and shown together. <br>Click <b>Next</b> to highlight the next sentence. Click <b>Finish</b> after reading the last one.</p>
    <textarea id="passageInput" placeholder="Paste your text here..."></textarea><br>
    <button id="btnStart">Start</button>
  </div>

  <div id="reader" aria-live="polite">
    <div id="sentencesWrap">
      <div id="sentences"></div>
    </div>
    <div id="hud">
      <div id="progress">—</div>
      <button id="bigBtn">Next →</button>
    </div>
  </div>

<script>
// ====== Sentence splitting with robust rules ======
// Abbreviation list to avoid false splits
const ABBREV = ["Mr.","Mrs.","Ms.","Dr.","Prof.","Sr.","Jr.","vs.","e.g.","i.e.","etc."];
// Characters that can appear right after punctuation before capital (quotes/parentheses/brackets)
const OPENERS = ['"', "'", "“", "”", "‘", "’", "(", "[", "{"];

// Returns true if char is an opening quote/paren
function isOpener(ch){ return OPENERS.includes(ch); }

function splitIntoSentences(text){
  // Normalize line breaks to spaces so we don't split mid-sentence
  text = (text||'').replace(/\r\n/g,'\n').replace(/\n+/g,' ').replace(/[ \t\f\v]+/g,' ').trim();
  const out = [];
  let i = 0, start = 0;
  while (i < text.length) {
    const ch = text[i];
    if (ch==='.' || ch==='?' || ch==='!') {
      // Look back for the token before punctuation
      let j = i-1;
      while (j>=0 && text[j]===' ') j--;
      // grab previous token (letters and dots)
      let k = j;
      while (k>=0 && /[A-Za-z.]/.test(text[k])) k--;
      const prevToken = text.slice(k+1, j+1);
      // Peek ahead through spaces and allowed openers, then expect a capital
      let h = i+1;
      while (h<text.length && text[h]===' ') h++;
      while (h<text.length && isOpener(text[h])) h++;
      const nextIsCapital = h<text.length && /[A-Z]/.test(text[h]);

      const abbrevHit = ABBREV.includes(prevToken + ch);
      if (!abbrevHit && nextIsCapital) {
        // Commit a sentence
        const sent = text.slice(start, i+1).trim();
        if (sent) out.push(sent);
        // Skip following spaces/openers
        i = h;
        start = i;
        continue;
      }
    }
    i++;
  }
  // last tail
  const tail = text.slice(start).trim();
  if (tail) out.push(tail);
  return out;
}

// ====== CSV helpers ======
function csvEscape(val){ if(typeof val==='string'){ return '"'+val.replace(/"/g,'""')+'"'; } return val; }
function downloadCSV(rows){
  const header=['sentence_index','sentence_text','word_count','dwell_seconds','wpm'];
  const lines=[header.join(',')];
  rows.forEach(r=> lines.push([r.index, csvEscape(r.text), r.words, r.dwell.toFixed(2), r.wpm.toFixed(2)].join(',')));
  const csv = "\uFEFF" + lines.join("\r\n"); // real BOM + CRLF
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='reading_sentences_manual.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

// ====== App state ======
let sentences=[], idx=0, tStart=null, results=[];

// Render & layout
function renderSentences(){
  const box=document.getElementById('sentences');
  box.innerHTML='';
  sentences.forEach((s,i)=>{
    const div=document.createElement('div');
    div.className='sentence'; div.dataset.index=i; div.textContent=s;
    box.appendChild(div);
  });
  setActive(0);
  scaleToFit();
}

function setActive(i){
  document.querySelectorAll('.sentence').forEach(el=> el.classList.remove('active'));
  const el=document.querySelector('.sentence[data-index="'+i+'"]');
  if(el){ el.classList.add('active'); el.scrollIntoView({behavior:'smooth', block:'center'}); }
  idx=i;
  document.getElementById('progress').textContent = (i+1)+' / '+sentences.length;
  const btn=document.getElementById('bigBtn');
  btn.textContent = (i===sentences.length-1) ? 'Finish' : 'Next →';
}

// Font scaling to fill the window without scrolling
function scaleToFit(){
  const wrap=document.getElementById('sentencesWrap');
  const box=document.getElementById('sentences');
  let size=112; box.style.fontSize=size+'px';
  let guard=0;
  while(guard++<220){
    const fits = (box.scrollHeight <= wrap.clientHeight) && (box.scrollWidth <= wrap.clientWidth);
    if(fits){
      // Try to grow more
      let grew=false;
      for(let step=8; step>=1; step=Math.floor(step/2)){
        box.style.fontSize=(size+step)+'px';
        if(box.scrollHeight <= wrap.clientHeight && box.scrollWidth <= wrap.clientWidth){
          size+=step; grew=true;
        } else {
          box.style.fontSize=size+'px';
        }
      }
      break;
    }else{
      size-=2;
      if(size<=10){ size=10; box.style.fontSize=size+'px'; break; }
      box.style.fontSize=size+'px';
    }
  }
}

function wordsIn(s){ return (s.match(/\S+/g)||[]).length; }

function startReading(){
  const text=document.getElementById('passageInput').value;
  sentences = splitIntoSentences(text);
  if(sentences.length===0){ alert('Please paste some text.'); return; }
  results=[];
  document.getElementById('setup').style.display='none';
  document.getElementById('reader').style.display='block';
  renderSentences();
  tStart=Date.now();
}

function advance(){
  if(tStart==null) return;
  const delta=(Date.now()-tStart)/1000;
  const text=sentences[idx];
  const words=wordsIn(text);
  const wpm = delta>0 ? (words/(delta/60)) : 0;
  results.push({index: idx+1, text, words, dwell: delta, wpm});
  if(idx===sentences.length-1){
    finish();
  }else{
    setActive(idx+1);
    tStart=Date.now();
  }
}

function finish(){
  tStart=null;
  downloadCSV(results);
}

document.getElementById('btnStart').addEventListener('click', startReading);
document.getElementById('bigBtn').addEventListener('click', advance);
window.addEventListener('keydown', (e)=>{
  if(document.getElementById('reader').style.display!=='block') return;
  if(e.key===' '||e.key==='Enter'||e.key==='ArrowRight'){ e.preventDefault(); advance(); }
});
window.addEventListener('resize', ()=>{ if(document.getElementById('reader').style.display==='block') scaleToFit(); });
</script>
</body>
</html>
